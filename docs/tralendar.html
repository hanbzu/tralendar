<!DOCTYPE html>

<html>
<head>
  <title>tralendar.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>tralendar.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> d3 = <span class="hljs-built_in">require</span>(<span class="hljs-string">'d3'</span>),
    moment = <span class="hljs-built_in">require</span>(<span class="hljs-string">'moment'</span>)

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">tralendar</span><span class="hljs-params">()</span> </span>{

  <span class="hljs-keyword">var</span> config = {
    start: chooseFirstDay(moment().startOf(<span class="hljs-string">'day'</span>)),
    days: <span class="hljs-number">35</span>,
    mouseoverCallback: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(_)</span> </span>{ <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'mouseover callback'</span>, _) },
    mouseoutCallback: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(_)</span> </span>{ <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'mouseout callback'</span>, _) },
    clickCallback: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(_)</span> </span>{ <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'click callback'</span>, _) }
  }
  
  <span class="hljs-keyword">var</span> ol <span class="hljs-comment">// Initialise the root ol as undefined</span>

  <span class="hljs-comment">/** The first day has to be the beginning of a week, unless the month starts later */</span>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">chooseFirstDay</span><span class="hljs-params">(start)</span> </span>{
    <span class="hljs-keyword">return</span> moment.max(moment(start).startOf(<span class="hljs-string">'week'</span>), moment(start).startOf(<span class="hljs-string">'month'</span>))
  }

  <span class="hljs-comment">/** A base calendar is an array of days from the start day to the
    end of the month containing the start day + the number of days */</span>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">generateCalendar</span><span class="hljs-params">()</span> </span>{

    <span class="hljs-comment">/** Extend number of days till the end of the month */</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">extendedDays</span><span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">var</span> last = moment(config.start)
          .add(config.days, <span class="hljs-string">'days'</span>)
          .endOf(<span class="hljs-string">'month'</span>)
          .endOf(<span class="hljs-string">'day'</span>)

      <span class="hljs-keyword">return</span> last.diff(config.start, <span class="hljs-string">'days'</span>) + <span class="hljs-number">1</span>
    }

    <span class="hljs-keyword">return</span> d3.range(<span class="hljs-number">0</span>, extendedDays()).map(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(_)</span> </span>{
      <span class="hljs-keyword">return</span> moment(config.start).add(_, <span class="hljs-string">'days'</span>)
    })
  }

  <span class="hljs-comment">/** An extended calendar is nested by year-month and has padding to respect weekdays */</span>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">generateExtendedCalendar</span><span class="hljs-params">(calendar, eventDays)</span> </span>{

    <span class="hljs-comment">/** Adds as many undefined items as extra days are in the first week of each month. */</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">addDayPadding</span><span class="hljs-params">(_)</span> </span>{
      <span class="hljs-keyword">var</span> dayOne = moment(_[<span class="hljs-number">0</span>].moment),
          weekdayOne = moment(dayOne).weekday(<span class="hljs-number">0</span>)
      <span class="hljs-keyword">if</span> (dayOne != weekdayOne)
        <span class="hljs-keyword">return</span> d3.range(dayOne.diff(weekdayOne, <span class="hljs-string">'days'</span>))
                 .map(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{ <span class="hljs-keyword">return</span> { isBlank: <span class="hljs-literal">true</span> } })
                 .concat(_)
      <span class="hljs-keyword">else</span>
        <span class="hljs-keyword">return</span> _
    }

    <span class="hljs-comment">/** Out of a moment element it creates a rich item depending on days set */</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">buildItem</span><span class="hljs-params">(_)</span> </span>{

      <span class="hljs-keyword">var</span> day = moment(_).format(<span class="hljs-string">'YYYY-MM-DD'</span>),
          inEventDays = eventDays.has(day)

      <span class="hljs-keyword">return</span> {
        hasEvent: inEventDays,
        yearmonth: _.format(<span class="hljs-string">'YYYY-MM'</span>),
        moment: _,
        extra: inEventDays ? eventDays.get(day)[<span class="hljs-number">0</span>].extra : <span class="hljs-string">''</span>, <span class="hljs-comment">// I take 0 because I may get more than a day</span>
        chosen: inEventDays ? eventDays.get(day)[<span class="hljs-number">0</span>].chosen : <span class="hljs-literal">false</span>
      }
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Nest a rich item array</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">return</span> d3.nest()
        .key(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(_)</span> </span>{ <span class="hljs-keyword">return</span> _.yearmonth }) <span class="hljs-comment">// ...with year-month as a key</span>
        .sortKeys(d3.ascending) <span class="hljs-comment">// ...ascending year-month order</span>
        .rollup(addDayPadding) <span class="hljs-comment">// ...adding extra padding days as undefined items</span>
        .entries(calendar.map(buildItem)) <span class="hljs-comment">// ...out of calendar days turned into rich items</span>
  }


  <span class="hljs-keyword">var</span> exports = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(_selection)</span> </span>{
    _selection.each(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(_data)</span> </span>{
      
      <span class="hljs-comment">/** Here we update what goes into ol.calendar (li items) */</span>
      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">updateDayList</span><span class="hljs-params">(d)</span> </span>{

        <span class="hljs-keyword">var</span> ol = d3.select(<span class="hljs-keyword">this</span>).select(<span class="hljs-string">'ol'</span>).selectAll(<span class="hljs-string">'li'</span>)
                   .data(d.values)

        ol.enter()
          .append(<span class="hljs-string">'li'</span>)
          .each(updateDay)

        ol.exit()
          .remove()
      }

      <span class="hljs-comment">/** Here we update what's into each of the ol.calendar &gt; li items (day, extra info, class, onclick...) */</span>
      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">updateDay</span><span class="hljs-params">(d)</span> </span>{

        <span class="hljs-keyword">var</span> li = d3.select(<span class="hljs-keyword">this</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>If there is no data (isBlank) weâ€™ve got padding (blank li)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        li.classed(<span class="hljs-string">'blank'</span>, d.isBlank)

        <span class="hljs-keyword">if</span> (!d.isBlank) {
          li.classed(<span class="hljs-string">'disabled'</span>, !d.hasEvent)
            .text(moment(d.moment).format(<span class="hljs-string">'D'</span>))
          <span class="hljs-keyword">if</span> (d.hasEvent) {
            li.classed(<span class="hljs-string">'chosen'</span>, d.chosen)
            li.on(<span class="hljs-string">'mouseover'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(_)</span> </span>{ config.mouseoverCallback(_) })
            li.on(<span class="hljs-string">'mouseout'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(_)</span> </span>{ config.mouseoutCallback(_) })
            li.on(<span class="hljs-string">'click'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(_)</span> </span>{
              <span class="hljs-keyword">var</span> day = d3.select(<span class="hljs-keyword">this</span>)
              day.classed(<span class="hljs-string">'chosen'</span>, !day.classed(<span class="hljs-string">'chosen'</span>))
              config.clickCallback(_)
            })
          }
        }
      }

      <span class="hljs-keyword">var</span> calendar = generateCalendar(),
          data = generateExtendedCalendar(calendar, _data)

      <span class="hljs-keyword">if</span> (!ol) <span class="hljs-comment">// Create the root ol if it's not there yet</span>
        ol = d3.select(<span class="hljs-keyword">this</span>)
          .append(<span class="hljs-string">'ol'</span>).classed(<span class="hljs-string">'calendar'</span>, <span class="hljs-literal">true</span>)

      <span class="hljs-keyword">var</span> li = ol.selectAll(<span class="hljs-string">'li'</span>)
          .data(data, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(d)</span> </span>{ <span class="hljs-keyword">return</span> d.key })

      <span class="hljs-keyword">var</span> monthLi = li.enter()
        .append(<span class="hljs-string">'li'</span>).classed(<span class="hljs-string">'month'</span>, <span class="hljs-literal">true</span>)
      
      monthLi
        .append(<span class="hljs-string">'h1'</span>).classed(<span class="hljs-string">'monthname'</span>, <span class="hljs-literal">true</span>)
        .text(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(d)</span> </span>{ <span class="hljs-keyword">return</span> moment(d.key, <span class="hljs-string">'YYYY-MM'</span>).format(<span class="hljs-string">'MMMM'</span>) }) <span class="hljs-comment">// July</span>
        
      monthLi
        .append(<span class="hljs-string">'ol'</span>).classed(<span class="hljs-string">'daygrid'</span>, <span class="hljs-literal">true</span>)

      li.exit()
        .remove()

      li.each(updateDayList)
    })
  }

  exports.starts = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(_)</span> </span>{
    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">arguments</span>.length) <span class="hljs-keyword">return</span> config.start.format(<span class="hljs-string">'YYYY-MM-DD'</span>)
    config.start = chooseFirstDay(moment(_, <span class="hljs-string">'YYYY-MM-DD'</span>))
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>
  }

  exports.span = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(_)</span> </span>{
    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">arguments</span>.length) <span class="hljs-keyword">return</span> config.days
    config.days = _
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>
  }

  exports.clickCallback = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(_)</span> </span>{
    config.clickCallback = _
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>
  }

  exports.mouseoverCallback = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(_)</span> </span>{
    config.mouseoverCallback = _
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>
  }

  exports.mouseoutCallback = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(_)</span> </span>{
    config.mouseoutCallback = _
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>
  }

  exports.test = {
    calendar: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">return</span> generateCalendar(config.start, config.days)
    },
    extendedCalendar: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(calendar, data)</span> </span>{
      <span class="hljs-keyword">return</span> generateExtendedCalendar(calendar, data)
    }
  }

  <span class="hljs-keyword">return</span> exports
}

<span class="hljs-built_in">module</span>.exports = tralendar</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
